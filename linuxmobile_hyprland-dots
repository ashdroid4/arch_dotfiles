"""
This script will help install https://github.com/linuxmobile/hyprland-dots
on your Arch Linux."""

#---------------------------------IMPORTS-------------------------------------#
import typing
from sys import exit
from os import system
from subprocess import run as foo
#-----------------------------------------------------------------------------#

#-------------------------------CONSTANTS----------------------------------#
pacman_dependencies = (
"hyprland wayland dunst nwg-look wf-recorder wlsunset rsync "
"colord ffmpegthumbnailer gnome-keyring gtk-engine-murrine imagemagick kvantum pamixer playerctl " 
"polkit-kde-agent qt5-quickcontrols qt5-quickcontrols2 qt5-wayland qt6-wayland ttf-font-awesome tumbler ttf-jetbrains-mono "
"xdg-desktop-portal-hyprland xdotool cliphist qt5-imageformats qt5ct "
"btop neofetch noise-suppression-for-voice  rofi-emoji starship zsh viewnior "
"cava rofi-lbonn-wayland ocs-url hyprpicker wlogout grimblast swww ttf-icomoon-feather "
"brave-bin file-roller noto-fonts noto-fonts-cjk noto-fonts-emoji thunar thunar-archive-plugin "
"catppuccin-gtk-theme-macchiato catppuccin-gtk-theme-mocha papirus-icon-theme sddm swaylock-effects kvantum "
"pipewire pipewire-alsa pipewire-audio pipewire-pulse pipewire-jack wireplumber gst-plugin-pipewire pavucontrol"
)

green = "\033[0;32m"; red = "\033[0;31m"; blue = "\033[0;36m"; nocolor = "\e[m"
#--------------------------------------------------------------------------#

#-----------------------------Script Start---------------------------#

# This function will echo the print the messages in the terminal.
def echo(arg: str):
    system(f'echo -e "{arg}"')

echo(f"""
This script will help you download and setup your Hyprland Window Manager.
The script will continue in the following steps:
{green}
1. It will add a repo Chaotic-AUR if needed.
2. It will install all the dependencies.
3. It will write the needed config for Hyprland.{nocolor}""")
            
# This function will determine the input as True or False or YesForAll.
def yon(arg:str, simple=True) -> bool:
    response = input(arg)

    if simple: return True if "y" in response else False

    if "yes" or "y" in response: return "true"

    if response == "skip" or response == "s": return "false"

    if "all" in response: return "all"
    
# Just modifying the subprocess.run() to give desired outputs.
def run(arg:str):
    try: 
        foo(arg, shell=True, check=True) # This foo is subprocess.run()
    except Exception:
        echo(f"\n\n{red}While executing the command '{arg}', the above error occured.{nocolor}")
        proceed = yon(
    "\nWell, I can't possibly know what error you enountered. "
    "If you don't want to proceed, the script will abort.\n"
    "Do you want to proceed? Yes or No: "
    )
        if not proceed: 
            print("Okay, aborted!")
            exit()

# Let's add a repo Chaotic-AUR.

chaoticScript = """
pacman-key --init
pacman-key --recv-key 3056513887B78AEB --keyserver keyserver.ubuntu.com
pacman-key --lsign-key 3056513887B78AEB
pacman -U 'https://cdn-mirror.chaotic.cx/chaotic-aur/chaotic-keyring.pkg.tar.zst'
pacman -U 'https://cdn-mirror.chaotic.cx/chaotic-aur/chaotic-mirrorlist.pkg.tar.zst'"""

chaoticRepo = """\n
[chaotic-aur]
Include = /etc/pacman.d/chaotic-mirrorlist"""

with open("/etc/pacman.conf", "r") as c: pacman_conf = c.read()

if "chaotic-aur" not in pacman_conf:
    echo(f"\n\n{blue}Now, I have to install all the dependencies. To do this, I have to add another repo called Chaotic-Aur.\n"
         f"I am very lazy so you have to say yes or the installation will abort.{nocolor}")

    ChaoticAUR = yon("\nDo you want to add Chaotic-Aur? "
                     "Yes or No: ")

    if not ChaoticAUR: exit()

    run(chaoticScript)
    with open("/etc/pacman.conf", "w") as c: c.write(pacman_conf + chaoticRepo)

    system("pacman -Sy")


# Let's move on to installing dependencies.

echo(f"\n\n{blue}Installing Dependencies...")
echo(f"(you can edit the dependencies as you want in the arch_dotfiles/linuxmobile_hyprland-dots){nocolor}\n")

run(f"pacman -S --needed {pacman_dependencies}")

# Let's configure the dotfiles.

run("rsync -avxHAXP --exclude '.git*' $HOME/Downloads/linuxmobile_hyprland-dots/* ~/")

# The final words.

echo(f"""
{green}Everything is set up! Now, you can enjoy your Hyprland.
To quickly login to Hyprland, use the command {blue}Hyprland.
{green}I recommend you to configure {red}sddm{green}.{nocolor}"""
)

#-----------------------------Script End-----------------------------#
